<% content_for(:title, t(:audit_details, default: 'Audit Details')) %>

<div class="page-header d-print-none">
  <div class="container-fluid">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle">
          <%= link_to audits_path, class: 'text-muted' do %>
            <%= t(:audit_trail, default: 'Audit Trail') %>
          <% end %>
        </div>
        <h2 class="page-title">
          <%= t(:audit_details, default: 'Audit Details') %>
        </h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <%= link_to audits_path, class: 'btn btn-outline-primary' do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <line x1="5" y1="12" x2="19" y2="12"></line>
            <line x1="5" y1="12" x2="11" y2="18"></line>
            <line x1="5" y1="12" x2="11" y2="6"></line>
          </svg>
          <%= t(:back_to_audit_log, default: 'Back to Audit Log') %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-fluid">
    <div class="row">
      <!-- Basic Information -->
      <div class="col-12">
        <div class="card mb-3">
          <div class="card-header">
            <h3 class="card-title"><%= t(:basic_information, default: 'Basic Information') %></h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <dl class="row">
                  <dt class="col-5"><%= t(:date_time, default: 'Date & Time') %>:</dt>
                  <dd class="col-7"><%= @version.created_at.strftime('%Y-%m-%d %H:%M:%S %Z') %></dd>
                  
                  <dt class="col-5"><%= t(:user, default: 'User') %>:</dt>
                  <dd class="col-7">
                    <% if @version.whodunnit.present? %>
                      <% user = User.find_by(id: @version.whodunnit) %>
                      <% if user %>
                        <div class="d-flex align-items-center">
                          <span class="avatar avatar-sm rounded-circle me-2">
                            <%= user.initials %>
                          </span>
                          <%= user.fullname %>
                        </div>
                      <% else %>
                        <span class="text-muted">ID: <%= @version.whodunnit %></span>
                      <% end %>
                    <% else %>
                      <span class="text-muted">System</span>
                    <% end %>
                  </dd>
                  
                  <dt class="col-5"><%= t(:action, default: 'Action') %>:</dt>
                  <dd class="col-7">
                    <% case @version.event %>
                    <% when 'create' %>
                      <span class="badge bg-success"><%= t('audit.create', default: 'Created') %></span>
                    <% when 'update' %>
                      <span class="badge bg-warning"><%= t('audit.update', default: 'Updated') %></span>
                    <% when 'destroy' %>
                      <span class="badge bg-danger"><%= t('audit.destroy', default: 'Deleted') %></span>
                    <% end %>
                  </dd>
                </dl>
              </div>
              
              <div class="col-md-6">
                <dl class="row">
                  <dt class="col-5"><%= t(:item_type, default: 'Type') %>:</dt>
                  <dd class="col-7">
                    <span class="badge bg-outline text-primary">
                      <%= @version.item_type %>
                    </span>
                  </dd>
                  
                  <dt class="col-5"><%= t(:item_id, default: 'Item ID') %>:</dt>
                  <dd class="col-7"><%= @version.item_id %></dd>
                  
                  <dt class="col-5"><%= t(:item_name, default: 'Item Name') %>:</dt>
                  <dd class="col-7">
                    <% if @item %>
                      <% case @version.item_type %>
                      <% when 'Patient' %>
                        <%= @item.fullname %>
                      <% when 'Doctor' %>
                        <%= @item.fullname %>
                      <% when 'User' %>
                        <%= @item.fullname %>
                      <% when 'Practice' %>
                        <%= @item.name %>
                      <% when 'Appointment' %>
                        <%= @item.notes.present? ? @item.notes : "Appointment ##{@item.id}" %>
                      <% when 'Treatment' %>
                        <%= @item.name %>
                      <% when 'Datebook' %>
                        <%= @item.name %>
                      <% else %>
                        ID: <%= @version.item_id %>
                      <% end %>
                    <% else %>
                      <span class="text-muted"><%= deleted_item_display_name(@version) %></span>
                    <% end %>
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Changes (for update events) -->
      <% if @version.event == 'update' && @version.object_changes.present? %>
        <div class="col-12">
          <div class="card mb-3">
            <div class="card-header">
              <h3 class="card-title"><%= t(:changes_made, default: 'Changes Made') %></h3>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-vcenter">
                  <thead>
                    <tr>
                      <th><%= t(:field, default: 'Field') %></th>
                      <th><%= t(:old_value, default: 'Old Value') %></th>
                      <th><%= t(:new_value, default: 'New Value') %></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% begin %>
                      <% changes = parse_version_changes_data(@version) %>
                      
                      <% if changes.present? %>
                        <% changes.each do |field, change_data| %>
                          <% 
                            # Handle different formats of change data
                            if change_data.is_a?(Array) && change_data.length == 2
                              old_value, new_value = change_data
                            else
                              # Skip if not in expected format
                              next
                            end
                          %>
                          <% next if field.in?(['updated_at', 'created_at', 'id']) %>
                          <tr>
                            <td>
                              <strong><%= field.humanize %></strong>
                            </td>
                            <td>
                              <% if old_value.present? %>
                                <% if field.include?('password') %>
                                  <span class="text-muted">[Hidden]</span>
                                <% else %>
                                  <code><%= truncate(old_value.to_s, length: 100) %></code>
                                <% end %>
                              <% else %>
                                <span class="text-muted"><%= t(:empty, default: '(empty)') %></span>
                              <% end %>
                            </td>
                            <td>
                              <% if new_value.present? %>
                                <% if field.include?('password') %>
                                  <span class="text-muted">[Hidden]</span>
                                <% else %>
                                  <code><%= truncate(new_value.to_s, length: 100) %></code>
                                <% end %>
                              <% else %>
                                <span class="text-muted"><%= t(:empty, default: '(empty)') %></span>
                              <% end %>
                            </td>
                          </tr>
                        <% end %>
                      <% else %>
                        <tr>
                          <td colspan="3">
                            <div class="alert alert-info">
                              <%= t(:no_changes_recorded, default: 'No detailed changes recorded for this update.') %>
                            </div>
                          </td>
                        </tr>
                      <% end %>
                    <% rescue => e %>
                      <tr>
                        <td colspan="3">
                          <div class="alert alert-warning">
                            <%= t(:error_parsing_changes, default: 'Error parsing change data') %>: <%= e.message %>
                            <br><small class="text-muted">Debug: <%= @version.object_changes.present? ? 'Data present' : 'No data' %></small>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Object Data (for create and destroy events) -->
      <% if (@version.event == 'create' || @version.event == 'destroy') && @version.object.present? %>
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <% if @version.event == 'create' %>
                  <%= t(:created_data, default: 'Created Data') %>
                <% else %>
                  <%= t(:deleted_data, default: 'Deleted Data') %>
                <% end %>
              </h3>
            </div>
            <div class="card-body">
              <% begin %>
                <% object_data = parse_version_object_data(@version) %> 
                <% if object_data.present? %>
                <div class="table-responsive">
                  <table class="table table-vcenter">
                    <thead>
                      <tr>
                        <th><%= t(:field, default: 'Field') %></th>
                        <th><%= t(:value, default: 'Value') %></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% object_data.each do |field, value| %>
                        <tr>
                          <td><strong><%= field.humanize %></strong></td>
                          <td>
                            <% if value.present? %>
                              <% if field.include?('password') %>
                                <span class="text-muted">[Hidden]</span>
                              <% else %>
                                <code><%= truncate(value.to_s, length: 100) %></code>
                              <% end %>
                            <% else %>
                              <span class="text-muted"><%= t(:empty, default: '(empty)') %></span>
                            <% end %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
                <% else %>
                <div class="alert alert-info">
                  <%= t(:no_object_data, default: 'No object data available for this record.') %>
                </div>
                <% end %>
              <% rescue => e %>
                <div class="alert alert-warning">
                  <%= t(:error_parsing_data, default: 'Error parsing object data') %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
